<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServEase Referral Engine - Interactive Proposal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d121c;
            --card-bg: #1a202c;
            --border-color: #2d3748;
            --primary-text: #e2e8f0;
            --secondary-text: #a0aec0;
            --accent-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 6px 18px rgba(2,6,23,0.6);
        }
        
        .pill {
            display: inline-flex;
            background-color: #2d3748;
            color: #a0aec0;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Lightweight replacements for previously using @apply in a build step */
        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(148,163,184,0.25);
            color: #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: .5rem;
            font-weight: 600;
            cursor: pointer;
        }

        .step-basic {
            padding: 0.5rem 0.75rem;
            background-color: #374151;
            color: #e6edf3;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 160ms ease;
        }
        .step-basic:hover { background-color: #4b5563; }

        /* Modal overlay transitions */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Utility to ensure small text colors align */
        .muted { color: #9aa6b8; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }

        /* Responsive improvements */
        @media (prefers-reduced-motion: reduce) {
            #bg-canvas { display: none; }
        }

        /* ensure table rows highlight still looks decent */
        tbody tr:hover { background-color: rgba(255,255,255,0.02); }

        /* Why this solution works tiles */
        .solution-tile {
            background-color: rgba(6,182,212,0.1);
            border-left: 4px solid var(--accent-color);
            padding: 1.5rem;
            border-radius: 0.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .solution-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(6,182,212,0.2);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Canvas for background animation (decorative) -->
    <canvas id="bg-canvas" aria-hidden="true"></canvas>

    <main class="container mx-auto max-w-7xl relative z-10 space-y-8">

        <!-- Hero Section -->
        <header class="card p-4 md:p-6 lg:p-10 flex flex-col items-start space-y-4" role="banner">
            <div class="flex-1 w-full">
                <h1 id="hero-headline" class="text-xl md:text-2xl lg:text-4xl font-extrabold text-white leading-tight"></h1>
                <p id="hero-subhead" class="mt-2 text-sm md:text-base lg:text-xl font-medium text-indigo-300"></p>
            </div>
            <div id="hero-stats" class="flex flex-wrap justify-center gap-3 w-full"></div>
        </header>

        <!-- Friction Points Section -->
        <section class="card p-4 md:p-6 lg:p-10" aria-labelledby="friction-title">
            <h2 id="friction-title" class="text-lg md:text-xl lg:text-2xl font-bold mb-4">Identifying Friction Points</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm md:text-base" role="table" aria-describedby="friction-desc">
                    <caption id="friction-desc" class="sr-only">Identifying friction points in referrals</caption>
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                        <tr>
                            <th scope="col" class="p-3 md:p-4 rounded-tl-lg">Friction Point</th>
                            <th scope="col" class="p-3 md:p-4">Root Cause</th>
                            <th scope="col" class="p-3 md:p-4 rounded-tr-lg">Solution</th>
                        </tr>
                    </thead>
                    <tbody id="friction-body" class="divide-y divide-gray-700">
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Strategy Matrix Section -->
        <section class="card p-4 md:p-6 lg:p-10" aria-labelledby="strategy-title">
            <h2 id="strategy-title" class="text-lg md:text-xl lg:text-2xl font-bold mb-4">Approach: Evaluate Referral Strategies</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm md:text-base" role="table" aria-describedby="strategy-desc">
                    <caption id="strategy-desc" class="sr-only">Evaluation of referral strategies</caption>
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                        <tr>
                            <th scope="col" class="p-3 md:p-4 rounded-tl-lg">Strategy</th>
                            <th scope="col" class="p-3 md:p-4">Customer Delight</th>
                            <th scope="col" class="p-3 md:p-4">Pain Solved</th>
                            <th scope="col" class="p-3 md:p-4">Friction</th>
                            <th scope="col" class="p-3 md:p-4">Decision</th>
                            <th scope="col" class="p-3 md:p-4 rounded-tr-lg">Reason</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body" class="divide-y divide-gray-700">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Referral Flow Section -->
        <section class="card p-6 md:p-10" aria-labelledby="refflow-title">
            <h2 id="refflow-title" class="text-xl md:text-2xl font-bold mb-4">Referral Flow (Interactive)</h2>
            <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
                <div id="referral-flow-steps" class="flex flex-wrap justify-center gap-2">
                    <div class="step-basic" data-step="post-service-modal" tabindex="0">Post-service modal (4★+)</div>
                    <div class="step-basic" data-step="contact-match" tabindex="0">Contact match & suggestion</div>
                    <div class="step-basic" data-step="one-tap-share" tabindex="0">One-tap share / gift</div>
                    <div class="step-basic" data-step="invite-signup" tabindex="0">Invite clicked & signup</div>
                    <div class="step-basic" data-step="first-booking" tabindex="0">Referee first booking → reward</div>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-400 text-center">Click any step to preview the UI copy and event names.</p>
        </section>

        <!-- Selected Strategies Section -->
        <section class="card p-6 md:p-10" aria-labelledby="selected-title">
            <h2 id="selected-title" class="text-xl md:text-2xl font-bold mb-4">Selected Strategies</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-white">Network-aware referral (Primary)</h3>
                    <p class="text-sm text-gray-400 mt-2">Implicit social proof: the app surfaces when a contact in the user's phone has used ServEase.</p>
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold">CTA Variations</h4>
                        <div class="mt-2 flex items-center justify-center space-x-2">
                            <button id="prevCta" class="btn-ghost text-lg" aria-label="Previous CTA">‹</button>
                            <div id="ctaText" class="flex-1 text-center bg-gray-800 rounded-lg p-3 text-sm"></div>
                            <button id="nextCta" class="btn-ghost text-lg" aria-label="Next CTA">›</button>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-white">Giftable / Future-use credits (Supporting)</h3>
                    <p class="text-sm text-gray-400 mt-2">Allow users to gift a credit redeemable anytime. Referrer receives reward when friend completes first booking.</p>
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold">CTA Variations</h4>
                        <div class="mt-2 flex items-center justify-center space-x-2">
                            <button id="prevGiftCta" class="btn-ghost text-lg" aria-label="Previous Gift CTA">‹</button>
                            <div id="giftCtaText" class="flex-1 text-center bg-gray-800 rounded-lg p-3 text-sm"></div>
                            <button id="nextGiftCta" class="btn-ghost text-lg" aria-label="Next Gift CTA">›</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Interactive KPI & Funnel Section -->
        <section id="interactive-funnel" class="card p-6 md:p-10" aria-labelledby="funnel-title">
          <h2 id="funnel-title" class="text-xl md:text-2xl font-bold mb-4">KPIs & Interactive Funnel Model</h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left: visual KPIs -->
            <div class="space-y-4">
              <div class="card p-4">
                <div class="flex items-baseline justify-between">
                  <div>
                    <div class="text-sm text-gray-400">Overall referral conversion</div>
                    <div id="overallPct" class="text-3xl md:text-4xl font-extrabold text-white">2.0%</div>
                  </div>
                  <div class="text-right">
                    <div class="text-sm text-gray-400">Target</div>
                    <div class="text-2xl font-bold text-indigo-300">10%</div>
                  </div>
                </div>
                <div class="mt-4">
                  <div class="text-sm text-gray-400">Projected referrals per 10,000 modals shown</div>
                  <div id="projectedCount" class="text-xl font-semibold text-white mt-1">200</div>
                </div>
              </div>

              <!-- Funnel sliders -->
              <div class="card p-4">
                <div class="text-sm text-gray-400 mb-2">Funnel stages (adjust sliders to simulate improvements)</div>
                <div class="space-y-3">
                  <label class="block text-xs text-gray-300">Modal → Share (<span id="s1pct">12.5</span>%)</label>
                  <input id="s1" type="range" min="1" max="60" step="0.1" value="12.5" class="w-full">
                  <label class="block text-xs text-gray-300">Share → Invite (<span id="s2pct">80</span>%)</label>
                  <input id="s2" type="range" min="10" max="100" step="0.1" value="80" class="w-full">
                  <label class="block text-xs text-gray-300">Invite → Signup (<span id="s3pct">40</span>%)</label>
                  <input id="s3" type="range" min="1" max="100" step="0.1" value="40" class="w-full">
                  <label class="block text-xs text-gray-300">Signup → First booking (<span id="s4pct">50</span>%)</label>
                  <input id="s4" type="range" min="1" max="100" step="0.1" value="50" class="w-full">
                </div>
              </div>
            </div>

            <!-- Right: recommended experiments + math -->
            <div class="space-y-4">
              <div class="card p-4">
                <h3 class="font-semibold text-white">Scenario & Maths</h3>
                <p class="text-sm text-gray-400 mt-2">The overall conversion is the product of the stage rates. Adjust sliders to see how per-stage improvements compound.</p>

                <div class="mt-3">
                  <div class="text-sm text-gray-300">Formula</div>
                  <div class="text-sm text-gray-200 mono mt-1">overall = s1 × s2 × s3 × s4</div>
                </div>

                <div class="mt-4 text-sm text-gray-300">
                  <div>Baseline example that results in <strong>2%</strong>:</div>
                  <ul class="list-disc list-inside mt-2 text-gray-400">
                    <li>Modal→Share: 12.5%</li>
                    <li>Share→Invite: 80%</li>
                    <li>Invite→Signup: 40%</li>
                    <li>Signup→Booking: 50%</li>
                  </ul>
                </div>
              </div>

              <div class="card p-4">
                <h3 class="font-semibold text-white">Recommended experiments (priority)</h3>
                <ol class="list-decimal list-inside mt-2 text-sm text-gray-400 space-y-2">
                  <li><strong>Contact-match + implicit social-proof</strong> — expect major modal→share lift.</li>
                  <li><strong>One-tap share stability + channel options</strong> — increases share→invite.</li>
                  <li><strong>Deep-link & auto-apply credit</strong> — increases invite→signup.</li>
                  <li><strong>1-click booking + nudges</strong> — increases signup→booking.</li>
                </ol>
              </div>

              <div class="card p-4">
                <button id="applySuggested" class="w-full py-2 px-4 font-semibold text-white rounded-lg bg-indigo-500 hover:bg-indigo-600 transition">Apply suggested 10% pathway</button>
              </div>

              <!-- Funnel stage quick-actions (keep drop-off mitigation clickable) -->
              <div class="card p-4">
                <div class="text-sm text-gray-300 mb-2">Quick funnel stages (click for mitigation ideas)</div>
                <div id="quick-funnel" class="grid grid-cols-2 gap-2">
                  <div class="step-basic" data-funnel="modal-shown" tabindex="0">Modal shown</div>
                  <div class="step-basic" data-funnel="share-clicked" tabindex="0">Share clicked</div>
                  <div class="step-basic" data-funnel="invite-sent" tabindex="0">Invite sent</div>
                  <div class="step-basic" data-funnel="first-booking" tabindex="0">First booking</div>
                  <div class="step-basic col-span-2" data-funnel="reward-redeemed" tabindex="0">Reward redeemed</div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- CAC & LTV Impact Section -->
        <section class="card p-6 md:p-10" aria-labelledby="impact-title">
            <h2 id="impact-title" class="text-xl md:text-2xl font-bold mb-4">Impact Analysis: LTV & CAC</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-white">Reduced Customer Acquisition Cost (CAC)</h3>
                    <p class="text-sm text-gray-400 mt-2">By shifting customer acquisition from paid channels to a high-converting referral engine, we can significantly reduce the cost of acquiring each new user. The viral loop created by satisfied customers sharing with friends is a highly efficient and cost-effective growth channel.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white">Increased Lifetime Value (LTV)</h3>
                    <p class="text-sm text-gray-400 mt-2">Referred customers typically have a higher LTV. They are more likely to have a higher retention rate and make repeat bookings, as they arrive with built-in trust from their friend's recommendation. This makes them a more valuable asset to the business over the long term.</p>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-white">Projected ROI</h3>
                <p class="text-sm text-gray-400 mt-2">A 10% referral conversion rate, combined with a lower CAC and higher LTV for referred users, projects a strong positive ROI for this initiative. The cost of the referral credit is a fraction of the LTV of a new, high-retention customer.</p>
            </div>
        </section>

        <!-- Final Summary -->
        <section class="card p-6 md:p-10" aria-labelledby="why-title">
            <h2 id="why-title" class="text-xl md:text-2xl font-bold mb-4">Why This Solution Works</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="solution-tile">
                    <h3 class="text-lg font-semibold text-white mb-2">Solves Timing Mismatch</h3>
                    <p class="text-sm text-gray-300">Connects referrals to a customer's real-time needs by surfacing them at the exact moment they are relevant, eliminating the common "no one to refer immediately" problem.</p>
                </div>
                <div class="solution-tile">
                    <h3 class="text-lg font-semibold text-white mb-2">Builds Trust & Delight</h3>
                    <p class="text-sm text-gray-300">Uses implicit social proof by showing a user that a friend has used the service, which is far more powerful than a generic referral link and creates a delightful, low-friction experience.</p>
                </div>
                <div class="solution-tile">
                    <h3 class="text-lg font-semibold text-white mb-2">Provides Meaningful Value</h3>
                    <p class="text-sm text-gray-300">Offers double-sided rewards in meaningful monetary amounts, ensuring that both the referrer and the referred user see a clear and valuable incentive to participate in the program.</p>
                </div>
                <div class="solution-tile">
                    <h3 class="text-lg font-semibold text-white mb-2">Highly Measurable</h3>
                    <p class="text-sm text-gray-300">Designed with clear, instrumentable events at every stage of the funnel, allowing for precise measurement, analysis, and optimization of the entire referral process from start to finish.</p>
                </div>
            </div>
        </section>

        <!-- Notification Message -->
        <div id="notification" class="fixed bottom-8 right-8 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden transition-opacity duration-300" role="status" aria-live="polite"></div>

    </main>

    <!-- Modal for interactive previews -->
    <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-body">
        <div class="card p-6 w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto" id="modal-content" role="document">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="text-sm text-gray-300 mb-4"></div>
            <div class="flex justify-end">
                <button id="close-modal" class="btn-ghost" aria-label="Close dialog">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Content data (unchanged structure)
        const content = {
            "hero": {
                "headline": "ServEase Referral Engine",
                "subhead": "Increase referral conversion from <2% to 10% in the next quarter. Solve temporal mismatch in hyperlocal services.",
                "stats": [
                    {"label": "Current participation", "value": "<2%"},
                    {"label": "Users rating 4★+", "value": "70%"},
                    {"label": "Repeat bookings", "value": "65%"},
                    {"label": "Target conversion", "value": "10%"}
                ]
            },
            "friction": [
                {"point": "No one to refer immediately", "cause": "Non-recurring services; friends may not need now", "solution": "Giftable credits; network-aware suggestions"},
                {"point": "Referral CTA buried", "cause": "Timing & visibility misaligned", "solution": "Post-service modal (4★+), in-app banner, receipt/email CTA"},
                {"point": "Too much effort to share", "cause": "Manual links / copy-paste", "solution": "One-tap share, deep links"},
                {"point": "Low perceived value", "cause": "Rewards too small or delayed", "solution": "Double-sided rewards; meaningful amounts"},
                {"point": "Trust missing", "cause": "Users hesitant to refer unknown service", "solution": "Network-aware referrals show friends who used service"}
            ],
            "matrix": [
                {"strategy": "Standard referral", "delight": "Medium", "pain": "Low", "value": "Medium", "friction": "Medium", "proof": "Medium", "decision": "Rejected", "reason": "Already present; low adoption (timing mismatch)"},
                {"strategy": "Group / neighborhood referral", "delight": "Medium", "pain": "Medium", "value": "Medium", "friction": "High", "proof": "Medium", "decision": "Rejected", "reason": "Complex coordination; clash with society apps"},
                {"strategy": "Gamification / milestones", "delight": "Medium", "pain": "Low", "value": "Medium", "friction": "Medium", "proof": "Low", "decision": "Rejected", "reason": "Perceived spam; low ROI for hyperlocal services"},
                {"strategy": "Network-aware referrals", "delight": "High", "pain": "High", "value": "High", "friction": "Low", "proof": "High", "decision": "Selected", "reason": "Implicit social-proof; surfaces referrals at point-of-need"},
                {"strategy": "Giftable credits", "delight": "High", "pain": "High", "value": "High", "friction": "Low", "proof": "Medium", "decision": "Selected", "reason": "Solves timing by allowing gifting for future use"}
            ],
            "cta_variations": [
                "Your friend Priya used this service and loved it! Book now & get ₹50 off.",
                "See how your friend Rahul saved time with ServEase — get ₹50 off your first service.",
                "Your friend Anjali trusted ServEase for home cleaning — try it today & enjoy ₹50 credit.",
                "Friends recommend ServEase — Priya did! Book now and earn ₹50 off."
            ],
            "gift_cta_variations": [
                "Gift a cleaning credit to your friend for later—both get ₹50 when they book!",
                "Share a future ₹100 AC repair credit with a friend—redeem anytime!",
                "Send a beauty service gift to Anjali—₹50 off for both on next booking.",
                "Gift credits for home services to Rahul—easy sharing, future use."
            ],
            "gift_ranges": [
                {"service": "Cleaning (₹500–1500)", "referrer": "₹50–₹100", "referee": "₹50–₹100", "notes": "~10% of service value"},
                {"service": "AC / Electrical (₹1500–5000)", "referrer": "₹100–₹200", "referee": "₹100–₹200", "notes": "Scales with ticket size"},
                {"service": "Beauty / Salon (₹300–1000)", "referrer": "₹30–₹75", "referee": "₹30–₹75", "notes": "Slightly lower; keeps CAC in check"}
            ],
            "kpis": [
                {"kpi": "Referral conversion rate", "target": "2% → 10%"},
                {"kpi": "Referral-driven new users", "target": "5× baseline"},
                {"kpi": "CAC via referrals", "target": "< ad CAC (~₹25 per new user)"},
                {"kpi": "Reward redemption", "target": "≥90% verified & redeemed"},
                {"kpi": "Channel effectiveness", "target": "WhatsApp/SMS vs in-app modal"}
            ],
            "events": ["modal_shown", "share_clicked", "invite_sent", "invite_accepted", "first_booking", "reward_redeemed"]
        };

        // UI-related JavaScript
        document.addEventListener('DOMContentLoaded', () => {

            /* ---------------------------
               Canvas background animation
               - stops on prefers-reduced-motion or when page hidden
            ---------------------------- */
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext && canvas.getContext('2d');
            let particles = [];
            let animReq = null;
            let reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            function resizeCanvas() {
                if (!ctx) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                particles = [];
                const count = Math.min(120, Math.floor((canvas.width * canvas.height) / 60000));
                for (let i = 0; i < count; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: Math.random() * 0.6 - 0.3,
                        vy: Math.random() * 0.6 - 0.3,
                        radius: Math.random() * 1.6 + 0.6
                    });
                }
            }
            if (ctx && !reducedMotion) {
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                function draw() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'rgba(255,255,255,0.04)';
                    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
                    ctx.lineWidth = 0.5;
                    particles.forEach(p1 => {
                        p1.x += p1.vx;
                        p1.y += p1.vy;
                        if (p1.x < 0 || p1.x > canvas.width) p1.vx *= -1;
                        if (p1.y < 0 || p1.y > canvas.height) p1.vy *= -1;
                        ctx.beginPath();
                        ctx.arc(p1.x, p1.y, p1.radius, 0, Math.PI * 2);
                        ctx.fill();
                        particles.forEach(p2 => {
                            const dist = Math.hypot(p1.x - p2.x, p1.y - p2.y);
                            if (dist < 90) {
                                ctx.beginPath();
                                ctx.moveTo(p1.x, p1.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        });
                    });
                    animReq = requestAnimationFrame(draw);
                }
                draw();

                // Pause animation when page not visible
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        if (animReq) cancelAnimationFrame(animReq);
                        animReq = null;
                    } else if (!animReq) {
                        draw();
                    }
                });
            } else {
                // hide canvas if reduced motion or no ctx
                canvas.style.display = 'none';
            }

            /* ---------------------------
               Modal (accessible)
            ---------------------------- */
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModal = document.getElementById('close-modal');
            let lastFocusedEl = null;

            function openModal(title, content) {
                lastFocusedEl = document.activeElement;
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modal.classList.add('active');
                // focus close button for quick keyboard access
                closeModal.focus();
                // trap focus simple approach
                document.addEventListener('focus', trapFocus, true);
                document.addEventListener('keydown', handleModalKeydown);
            }

            function closeModalFn() {
                modal.classList.remove('active');
                document.removeEventListener('focus', trapFocus, true);
                document.removeEventListener('keydown', handleModalKeydown);
                if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') lastFocusedEl.focus();
            }

            function trapFocus(e) {
                if (!modal.contains(e.target)) {
                    e.stopPropagation();
                    closeModal.focus();
                }
            }

            function handleModalKeydown(e) {
                if (e.key === 'Escape') {
                    closeModalFn();
                }
            }

            closeModal.addEventListener('click', closeModalFn);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModalFn();
            });

            /* ---------------------------
               Referral flow step clicks (preview modal)
            ---------------------------- */
            document.querySelectorAll('#referral-flow-steps [data-step]').forEach(step => {
                step.addEventListener('click', () => {
                    const type = step.getAttribute('data-step');
                    let title, content;
                    switch(type) {
                        case 'post-service-modal':
                            title = 'Post-Service Modal Preview';
                            content = '<strong>Event:</strong> <code>referral_modal_shown</code><br><br><strong>UI Copy:</strong> "Loved the service? Send a gift or share with friends — you both get a credit."';
                            break;
                        case 'contact-match':
                            title = 'Contact Match & Suggestion';
                            content = '<strong>Event:</strong> <code>contact_match_found</code><br><br><strong>UI:</strong> In-app banner - "Your friend Priya used this service and loved it! Book now & get a credit."';
                            break;
                        case 'one-tap-share':
                            title = 'One-tap Share / Gift';
                            content = '<strong>Event:</strong> <code>referral_share_clicked</code><br><br><strong>Flow:</strong> One-tap share to WhatsApp or SMS with a prefilled message and deep link.';
                            break;
                        case 'invite-signup':
                            title = 'Invite Clicked & Signup';
                            content = '<strong>Event:</strong> <code>referral_signup</code><br><br><strong>Flow:</strong> Deep link lands the new user on the booking flow with the promo code automatically applied.';
                            break;
                        case 'first-booking':
                            title = 'First Booking → Reward';
                            content = '<strong>Event:</strong> <code>referral_first_booking_completed</code><br><br><strong>Rule:</strong> The referrer receives their reward only after the referee completes their first paid booking.'; 
                            break;
                    }
                    openModal(title, content);
                });
                // keyboard accessibility
                step.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') step.click(); });
            });

            /* ---------------------------
               Funnel drop-off mitigation clicks
            ---------------------------- */
            document.querySelectorAll('#quick-funnel [data-funnel]').forEach(step => {
                step.addEventListener('click', () => {
                    const type = step.getAttribute('data-funnel');
                    let title, content;
                    switch(type) {
                        case 'modal-shown':
                            title = 'Drop-off Mitigation: Modal Shown';
                            content = '<strong>Problem:</strong> User closes the modal immediately.<br><br><strong>Mitigation:</strong> A/B test different copy, button placement, and timing. Consider a less intrusive banner instead of a full modal for some user segments.';
                            break;
                        case 'share-clicked':
                            title = 'Drop-off Mitigation: Share Clicked';
                            content = `<strong>Problem:</strong> User copies the link but doesn't send it.<br><br><strong>Mitigation:</strong> Ensure one-tap share buttons work flawlessly and the pre-filled message is compelling. Offer multiple sharing options (WhatsApp, SMS, social media).`;
                            break;
                        case 'invite-sent':
                            title = 'Drop-off Mitigation: Invite Sent';
                            content = `<strong>Problem:</strong> Friend receives the invite but doesn't click.<br><br><strong>Mitigation:</strong> Optimize the messaging for different channels. For example, a personal message from a friend is more effective on WhatsApp than on an email blast.`;
                            break;
                        case 'first-booking':
                            title = 'Drop-off Mitigation: First Booking';
                            content = `<strong>Problem:</strong> Friend signs up but never completes a booking.<br><br><strong>Mitigation:</strong> Send automated, personalized reminders. Highlight the value proposition and the credit they have waiting for them. Add in-app nudges.`;
                            break;
                        case 'reward-redeemed':
                            title = 'Drop-off Mitigation: Reward Redeemed';
                            content = `<strong>Problem:</strong> Referrer doesn't receive or claim their reward.<br><br><strong>Mitigation:</strong> Send a clear, celebratory notification as soon as the reward is credited. Make the credit easy to find and apply on their next booking.`;
                            break;
                    }
                    openModal(title, content);
                });
                step.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') step.click(); });
            });

            /* ---------------------------
               Populate hero
            ---------------------------- */
            document.getElementById('hero-headline').textContent = content.hero.headline;
            document.getElementById('hero-subhead').innerHTML = content.hero.subhead.replace(/<2%/g, '<span class="text-white font-extrabold"><2%</span>');
            const heroStats = document.getElementById('hero-stats');
            content.hero.stats.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'text-center min-w-[80px]';
                div.innerHTML = `<div class="text-lg md:text-2xl font-bold text-gray-50">${stat.value}</div><div class="text-xs md:text-sm text-gray-400">${stat.label}</div>`;
                heroStats.appendChild(div);
            });

            /* ---------------------------
               Populate friction table
            ---------------------------- */
            const frictionBody = document.getElementById('friction-body');
            content.friction.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-800 transition-colors';
                tr.innerHTML = `
                    <td class="p-3 md:p-4 font-medium">${row.point}</td>
                    <td class="p-3 md:p-4 text-gray-300">${row.cause}</td>
                    <td class="p-3 md:p-4 text-green-400">${row.solution}</td>
                `;
                frictionBody.appendChild(tr);
            });
            
            /* --------------------------- 
               Populate strategy matrix
            ---------------------------- */
            const matrixBody = document.getElementById('matrix-body');
            content.matrix.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = row.decision === 'Selected' ? 'bg-indigo-900 bg-opacity-20 text-indigo-200' : 'hover:bg-gray-800 transition-colors';
                tr.innerHTML = `
                    <td class="p-4">${row.strategy}</td>
                    <td class="p-4">${row.delight}</td>
                    <td class="p-4">${row.pain}</td>
                    <td class="p-4">${row.friction}</td>
                    <td class="p-4 font-bold ${row.decision === 'Selected' ? 'text-green-400' : 'text-red-400'}">${row.decision}</td>
                    <td class="p-4 text-sm text-gray-400">${row.reason}</td>
                `;
                matrixBody.appendChild(tr);
            });

            /* ---------------------------
               CTA carousels
            ---------------------------- */
            let ctas = content.cta_variations;
            let idx = 0;
            const ctaEl = document.getElementById('ctaText');
            ctaEl.textContent = ctas[idx];
            document.getElementById('nextCta').addEventListener('click', () => {
                idx = (idx + 1) % ctas.length;
                ctaEl.textContent = ctas[idx];
            });
            document.getElementById('prevCta').addEventListener('click', () => {
                idx = (idx - 1 + ctas.length) % ctas.length;
                ctaEl.textContent = ctas[idx];
            });

            let giftCtas = content.gift_cta_variations;
            let giftIdx = 0;
            const giftCtaEl = document.getElementById('giftCtaText');
            giftCtaEl.textContent = giftCtas[giftIdx];
            document.getElementById('nextGiftCta').addEventListener('click', () => {
                giftIdx = (giftIdx + 1) % giftCtas.length;
                giftCtaEl.textContent = giftCtas[giftIdx];
            });
            document.getElementById('prevGiftCta').addEventListener('click', () => {
                giftIdx = (giftIdx - 1 + giftCtas.length) % giftCtas.length;
                giftCtaEl.textContent = giftCtas[giftIdx];
            });


            /* ---------------------------
               Interactive funnel: sliders & suggested pathway
            ---------------------------- */
            (function setupInteractiveFunnel() {
                const s1 = document.getElementById('s1'), s2 = document.getElementById('s2'),
                      s3 = document.getElementById('s3'), s4 = document.getElementById('s4');
                const s1pct = document.getElementById('s1pct'), s2pct = document.getElementById('s2pct'),
                      s3pct = document.getElementById('s3pct'), s4pct = document.getElementById('s4pct');
                const overallPct = document.getElementById('overallPct'), projectedCount = document.getElementById('projectedCount');
                const applyBtn = document.getElementById('applySuggested');

                function update() {
                    const v1 = parseFloat(s1.value)/100;
                    const v2 = parseFloat(s2.value)/100;
                    const v3 = parseFloat(s3.value)/100;
                    const v4 = parseFloat(s4.value)/100;
                    const overall = v1 * v2 * v3 * v4;
                    const overallPercent = (overall * 100);
                    overallPct.textContent = overallPercent.toFixed(2) + '%';
                    const projected = Math.round(overall * 10000);
                    projectedCount.textContent = projected.toLocaleString();
                    s1pct.textContent = (v1*100).toFixed(1);
                    s2pct.textContent = (v2*100).toFixed(1);
                    s3pct.textContent = (v3*100).toFixed(1);
                    s4pct.textContent = (v4*100).toFixed(1);
                }

                [s1,s2,s3,s4].forEach(el => el.addEventListener('input', update));
                update();

                applyBtn.addEventListener('click', () => {
                    // Suggested pathway to ~10%
                    s1.value = 30; // modal -> share
                    s2.value = 90; // share -> invite
                    s3.value = 60; // invite -> signup
                    s4.value = 62; // signup -> booking
                    update();
                    applyBtn.textContent = 'Applied: ~10% pathway';
                    setTimeout(()=> applyBtn.textContent = 'Apply suggested 10% pathway', 2000);
                });
            })();

            /* ---------------------------
               Tiny notification API
            ---------------------------- */
            const notif = document.getElementById('notification');
            function showNotification(msg, ms=2500) {
                notif.textContent = msg;
                notif.classList.remove('hidden');
                notif.style.opacity = '1';
                setTimeout(()=> {
                    notif.style.opacity = '0';
                    setTimeout(()=> notif.classList.add('hidden'), 300);
                }, ms);
            }

            // Example: show initial hint
            setTimeout(()=> showNotification('Tip: click "Apply suggested 10% pathway" to see one concrete route.'), 1200);

        }); // DOMContentLoaded end
    </script>
</body>
</html>
